I"*<h4 id="起因">起因</h4>

<p>晚上 <strong>Android</strong> 客户端遇到奇怪的问题：在某台新配的服务器上，出现应用层获取 <strong>Header</strong> 自定义键 <strong>Authorization</strong> 时出现其值为空，但存在键 <strong>authorization</strong> 。</p>

<h4 id="调查">调查</h4>

<p>通过抓包发现几个疑点：</p>

<ul>
  <li>
    <p>问题以前没有出现，业务也是正常的，唯独连接到这台服务器会出现异常；</p>
  </li>
  <li>同一套代码，仅对这台服务器发出的请求行没有HTTP版本号，如：HTTP/1.1；</li>
  <li>所有请求体、响应体的字符全是小写；</li>
  <li>iOS业务运行没有问题，所以没有抓包查看；</li>
</ul>

<p>先修复客户端 HTTP/1.1 <strong>大小写不敏感</strong> 实现为 <strong>大小写敏感</strong> 的严重问题。调查的脚步不能就此终止，还要明确就为啥这台服务器如此突出。</p>

<p>由于晚上问题发现时后端同事下班了，又一直按照HTTP/1.1的定义查找问题，丝毫没有进展。最后想到HTTP/2才逐渐有头绪，后翻查RFC文档。</p>

<h4 id="rfc定义">RFC定义</h4>

<p>文档 <a href="https://tools.ietf.org/html/rfc7540#section-8.1.2">RFC7504</a> 明确指出Header的定义：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>8.1.2.  HTTP Header Fields

   HTTP header fields carry information as a series of key-value pairs.
   For a listing of registered HTTP headers, see the "Message Header
   Field" registry maintained at &lt;https://www.iana.org/assignments/
   message-headers&gt;.

   Just as in HTTP/1.x, header field names are strings of ASCII
   characters that are compared in a case-insensitive fashion.  However,
   header field names MUST be converted to lowercase prior to their
   encoding in HTTP/2.  A request or response containing uppercase
   header field names MUST be treated as malformed (Section 8.1.2.6).
</pre></td></tr></tbody></table></code></pre></div></div>

<p>从上文可知，<strong>HTTP/2</strong> 和 <strong>HTTP/1.x</strong> 同样使用 <strong>ASCII</strong> 字符集，但 <strong>HTTP/2</strong> 头部必须使用小写，而不像 <strong>HTTP/1.x</strong> 大小写均可。也正是碰上终端业务代码实现不严谨，引发上述问题。</p>

<p>最终确认这台服务端 <strong>Nginx</strong> 开启了 <strong>HTTP/2</strong>，且客户端问题已修复提交，调查结束。</p>

<h4 id="总结">总结</h4>

<p>对于任意网络协议，客户端在上层跟踪数据包有一定难度，所以先用抓包工具辅助是很好的习惯。</p>

<p>尽管各种协议更新演进，如果前端(业务代码、依赖库版本)或后端任意一方出现协议不兼容或实现不严谨，排查问题难度较高，所以应尽可能做到细致严谨。</p>

<p>对客户端来说，把所有HTTP的Header键字符串转换为小写，业务匹配时也用小写键名称(即equalsIgnoreCase)可同时适配 <strong>HTTP/2</strong> 和 <strong>HTTP/1.x</strong>。注意，如果转小写后出现多个相同Header，必须要求服务端修正，同时前端调整代码。</p>

:ET